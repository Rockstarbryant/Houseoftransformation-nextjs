Before we continue I would like you to follow my instructions.
1. My backend is using node.js my frontend is on Next.js framework.
2. I use superbase database for authentication only and MongoDB for roles and every other thing.
3. I use javascript in my files please DO NOT Write for me typescript files.
4. Strictly follow my instructions.
5. Be precise in your responces, this is to avoid hitting token limits and length limits too early before finishing the work.
6. Do not write unecessary files I have not asked for, always confirm with me before proceeding to write any file.
7. you are free to make suggestions but please you have to research on web if errors persist.
8. I will follow your guide keenly so if I tell you it did not work research for better solution rather than persisting on one thing or request for other files for reference.
9. If you think I have done anything wrong way maybe configured someothing the wrong way ask for a screenshot or my current file.
10. Lastly Before asking for a file confirm if I already sent you first, I do not want to send duplicate files.






rm -rf .next
rm -rf node_modules
npm install
npm run build



tree -L 3 -I 'node_modules'


npm cache clean --force
rm -rf .next node_modules
npm install
npm run build


 

<div className="absolute inset-0 bg-transparent" />


gradient-to-t from-slate-900 via-slate-900/40 to-

font-semibold font-serif fo
            


            import Link from "next/link";

            <Link  href="/portal/donations/campaigns"
              className="inline-flex items-center rounded-lg bg-red-600 px-5 py-2.5 text-white font-medium hover:bg-red-700 transition"
              >
                View campaigns
                </Link>

const progress = calculateCampaignProgress(campaign.currentAmount, campaign.goalAmount);
                const statusLabel = getCampaignStatusLabel(campaign.status);


                {/* Admin Donation Stats */}
              {canViewDonationReports() && (
                <div className="mt-8">
                  <AdminDonationStats payments={payments} />
                </div>
              )}

              {/* Admin Donation Stats */}
              {canViewDonationReports() && (
                <div className="mt-8">
                  <AdminDonationStats payments={payments} />
                </div>
              )}



              Csx5TBNinugjyxe4yCIhr3muWAHGCCYS4KB8gep7LjbtdwHefoDxqGT11sUcTEcc7vBfoC3UlYyOCeGLN+YJk2rZoExhUp7aX7wT0Hc5j9QjTH3wi3CUMbV4VKAF1J6C1o3wC6hY81Euy0n+zue/wEH/rh29sFLEdYKMeYuFEZCazTVL8n1hFt4I+61LlDZP9+spoeR8pYBw+638sc6y6KGir1+IPKsxdPSwE3xjPobh0Zp8gMBicAQpHyeD+rj+B8R9RgQN68jrP5NP5o+7wkUkXIZut0KjfBUPDykAo03kOz1Q8X32J/m/9/F6NB7AlWdwMO7WIXmCzBzB5wX4Jw==


              -- Create contributions table in Supabase
CREATE TABLE IF NOT EXISTS contributions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID NOT NULL REFERENCES campaigns(id) ON DELETE CASCADE,
  contributor_name TEXT NOT NULL,
  contributor_email TEXT,
  contributor_phone TEXT,
  amount DECIMAL(15, 2) NOT NULL CHECK (amount > 0),
  payment_method VARCHAR(50) NOT NULL DEFAULT 'mpesa',
  mpesa_ref TEXT,
  notes TEXT,
  is_anonymous BOOLEAN DEFAULT FALSE,
  status VARCHAR(50) DEFAULT 'pending',
  verified_by_id TEXT,
  verified_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_contributions_campaign ON contributions(campaign_id);
CREATE INDEX idx_contributions_status ON contributions(status);
CREATE INDEX idx_contributions_created ON contributions(created_at DESC);

-- RLS Policies
ALTER TABLE contributions ENABLE ROW LEVEL SECURITY;

-- Anyone can insert (for public contributions)
CREATE POLICY "allow_public_insert" ON contributions
  FOR INSERT WITH CHECK (true);

-- Users can view their own contributions
CREATE POLICY "users_view_own" ON contributions
  FOR SELECT USING (
    contributor_email = auth.jwt() ->> 'email' 
    OR auth.jwt() ->> 'role' = 'admin'
  );

-- Admins can view/update all
CREATE POLICY "admin_full_access" ON contributions
  FOR ALL USING (auth.jwt() ->> 'role' = 'admin');

-- Update updated_at on changes
CREATE OR REPLACE FUNCTION update_contributions_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_contributions_updated_at
BEFORE UPDATE ON contributions
FOR EACH ROW
EXECUTE FUNCTION update_contributions_updated_at();

-- Function to update campaign amount when contribution is verified
CREATE OR REPLACE FUNCTION update_campaign_from_contribution()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.status = 'verified' AND OLD.status != 'verified' THEN
    UPDATE campaigns
    SET current_amount = current_amount + NEW.amount
    WHERE id = NEW.campaign_id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_campaign_from_contribution
AFTER UPDATE ON contributions
FOR EACH ROW
EXECUTE FUNCTION update_campaign_from_contribution();


// ============================================
  // DATA FETCHING
  // ============================================

  const fetchAllData = useCallback(async () => {
  try {
    setIsLoading(true);
    setError(null);

    // Fetch campaigns
    if (canViewCampaigns()) {
      const campaignsRes = await donationApi.campaigns.getAll({ status: 'active' });
      if (campaignsRes.success) {
        setCampaigns(campaignsRes.campaigns || []);
      }
    }

    // Fetch user's pledges
    if (canViewPledges()) {
      const pledgesRes = await donationApi.pledges.getMyPledges(1, 50);
      if (pledgesRes.success) {
        const withCampaigns = joinCampaignsWithPledges(pledgesRes.pledges || [], campaigns);
        setMyPledges(withCampaigns);
      }
    }

    // Fetch all pledges (admin)
    if (canViewAllPledges()) {
      const allPledgesRes = await donationApi.pledges.getAllPledges(1, 100);
      if (allPledgesRes.success) {
        const withCampaigns = joinCampaignsWithPledges(allPledgesRes.pledges || [], campaigns);
        setAllPledges(withCampaigns);
      }
    }

    // Fetch payments
    if (canViewAllPayments()) {
      const paymentsRes = await donationApi.payments.getAll({ page: 1, limit: 100 });
      if (paymentsRes.success) {
        setPayments(paymentsRes.payments || []);
      }
    }

    // Fetch analytics
    if (canViewDonationReports()) {
      const analyticsRes = await donationApi.analytics.getDashboard();
      if (analyticsRes.success) {
        setAnalyticsData(analyticsRes.data);
      }
    }
  } catch (err) {
    console.error('[DONATIONS] Error fetching data:', err);
    setError(err.response?.data?.message || 'Failed to load donation data');
  } finally {
    setIsLoading(false);
  }
}, [canViewCampaigns, canViewPledges, canViewAllPledges, canViewAllPayments, canViewDonationReports]); // ‚Üê REMOVED campaigns dependency!




{canCreateCampaign() && (
              <div className={`${cardBg} rounded-3xl p-6 shadow-sm border ${border}`}>
                <button
                  onClick={() => {
                    alert('Campaign creation form will open here');
                  }}
                  className="w-full bg-gradient-to-r from-[#FDB022] to-[#FF9500] text-white py-4 rounded-2xl font-semibold shadow-md flex items-center justify-center gap-2"
                >
                  <Plus size={20} />
                  {canCreateCampaign() && (
                        <AdminCampaignManager onCampaignCreated={handleCampaignCreated} />
                      )}
                </button>
              </div>
            )}