Before we continue I would like you to follow my instructions.
1. My backend is using node.js my frontend is on Next.js framework.
2. I use superbase database for authentication only and MongoDB for roles and every other thing.
3. I use javascript in my files please DO NOT Write for me typescript files.
4. Strictly follow my instructions.
5. Be precise in your responces, this is to avoid hitting token limits and length limits too early before finishing the work.
6. Do not write unecessary files I have not asked for, always confirm with me before proceeding to write any file.
7. you are free to make suggestions but please you have to research on web if errors persist.
8. I will follow your guide keenly so if I tell you it did not work research for better solution rather than persisting on one thing or request for other files for reference.
9. If you think I have done anything wrong way maybe configured someothing the wrong way ask for a screenshot or my current file.
10. Lastly Before asking for a file confirm if I already sent you first, I do not want to send duplicate files.






rm -rf .next
rm -rf node_modules
npm install
npm run build



tree -L 3 -I 'node_modules'


npm cache clean --force
rm -rf .next node_modules
npm install
npm run build


 

<div className="absolute inset-0 bg-transparent" />


gradient-to-t from-slate-900 via-slate-900/40 to-

font-semibold font-serif fo
            


            import Link from "next/link";

            <Link  href="/portal/donations/campaigns"
              className="inline-flex items-center rounded-lg bg-red-600 px-5 py-2.5 text-white font-medium hover:bg-red-700 transition"
              >
                View campaigns
                </Link>

const progress = calculateCampaignProgress(campaign.currentAmount, campaign.goalAmount);
                const statusLabel = getCampaignStatusLabel(campaign.status);


                {/* Admin Donation Stats */}
              {canViewDonationReports() && (
                <div className="mt-8">
                  <AdminDonationStats payments={payments} />
                </div>
              )}

              {/* Admin Donation Stats */}
              {canViewDonationReports() && (
                <div className="mt-8">
                  <AdminDonationStats payments={payments} />
                </div>
              )}



              Csx5TBNinugjyxe4yCIhr3muWAHGCCYS4KB8gep7LjbtdwHefoDxqGT11sUcTEcc7vBfoC3UlYyOCeGLN+YJk2rZoExhUp7aX7wT0Hc5j9QjTH3wi3CUMbV4VKAF1J6C1o3wC6hY81Euy0n+zue/wEH/rh29sFLEdYKMeYuFEZCazTVL8n1hFt4I+61LlDZP9+spoeR8pYBw+638sc6y6KGir1+IPKsxdPSwE3xjPobh0Zp8gMBicAQpHyeD+rj+B8R9RgQN68jrP5NP5o+7wkUkXIZut0KjfBUPDykAo03kOz1Q8X32J/m/9/F6NB7AlWdwMO7WIXmCzBzB5wX4Jw==


              -- Create contributions table in Supabase
CREATE TABLE IF NOT EXISTS contributions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID NOT NULL REFERENCES campaigns(id) ON DELETE CASCADE,
  contributor_name TEXT NOT NULL,
  contributor_email TEXT,
  contributor_phone TEXT,
  amount DECIMAL(15, 2) NOT NULL CHECK (amount > 0),
  payment_method VARCHAR(50) NOT NULL DEFAULT 'mpesa',
  mpesa_ref TEXT,
  notes TEXT,
  is_anonymous BOOLEAN DEFAULT FALSE,
  status VARCHAR(50) DEFAULT 'pending',
  verified_by_id TEXT,
  verified_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_contributions_campaign ON contributions(campaign_id);
CREATE INDEX idx_contributions_status ON contributions(status);
CREATE INDEX idx_contributions_created ON contributions(created_at DESC);

-- RLS Policies
ALTER TABLE contributions ENABLE ROW LEVEL SECURITY;

-- Anyone can insert (for public contributions)
CREATE POLICY "allow_public_insert" ON contributions
  FOR INSERT WITH CHECK (true);

-- Users can view their own contributions
CREATE POLICY "users_view_own" ON contributions
  FOR SELECT USING (
    contributor_email = auth.jwt() ->> 'email' 
    OR auth.jwt() ->> 'role' = 'admin'
  );

-- Admins can view/update all
CREATE POLICY "admin_full_access" ON contributions
  FOR ALL USING (auth.jwt() ->> 'role' = 'admin');

-- Update updated_at on changes
CREATE OR REPLACE FUNCTION update_contributions_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_contributions_updated_at
BEFORE UPDATE ON contributions
FOR EACH ROW
EXECUTE FUNCTION update_contributions_updated_at();

-- Function to update campaign amount when contribution is verified
CREATE OR REPLACE FUNCTION update_campaign_from_contribution()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.status = 'verified' AND OLD.status != 'verified' THEN
    UPDATE campaigns
    SET current_amount = current_amount + NEW.amount
    WHERE id = NEW.campaign_id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_campaign_from_contribution
AFTER UPDATE ON contributions
FOR EACH ROW
EXECUTE FUNCTION update_campaign_from_contribution();


// ============================================
  // DATA FETCHING
  // ============================================

  const fetchAllData = useCallback(async () => {
  try {
    setIsLoading(true);
    setError(null);

    // Fetch campaigns
    if (canViewCampaigns()) {
      const campaignsRes = await donationApi.campaigns.getAll({ status: 'active' });
      if (campaignsRes.success) {
        setCampaigns(campaignsRes.campaigns || []);
      }
    }

    // Fetch user's pledges
    if (canViewPledges()) {
      const pledgesRes = await donationApi.pledges.getMyPledges(1, 50);
      if (pledgesRes.success) {
        const withCampaigns = joinCampaignsWithPledges(pledgesRes.pledges || [], campaigns);
        setMyPledges(withCampaigns);
      }
    }

    // Fetch all pledges (admin)
    if (canViewAllPledges()) {
      const allPledgesRes = await donationApi.pledges.getAllPledges(1, 100);
      if (allPledgesRes.success) {
        const withCampaigns = joinCampaignsWithPledges(allPledgesRes.pledges || [], campaigns);
        setAllPledges(withCampaigns);
      }
    }

    // Fetch payments
    if (canViewAllPayments()) {
      const paymentsRes = await donationApi.payments.getAll({ page: 1, limit: 100 });
      if (paymentsRes.success) {
        setPayments(paymentsRes.payments || []);
      }
    }

    // Fetch analytics
    if (canViewDonationReports()) {
      const analyticsRes = await donationApi.analytics.getDashboard();
      if (analyticsRes.success) {
        setAnalyticsData(analyticsRes.data);
      }
    }
  } catch (err) {
    console.error('[DONATIONS] Error fetching data:', err);
    setError(err.response?.data?.message || 'Failed to load donation data');
  } finally {
    setIsLoading(false);
  }
}, [canViewCampaigns, canViewPledges, canViewAllPledges, canViewAllPayments, canViewDonationReports]); // ‚Üê REMOVED campaigns dependency!




{/* TAB CONTENT */}
        <div className="p-6">
                  {/* OVERVIEW TAB */}
        {activeTab === 'overview' && (
          <div className="space-y-6 md:space-y-8">
            {/* Quick Stats */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              {canViewPledges() && (
                  <div className="bg-gradient-to-br from-blue-500 to-cyan-600 text-white rounded-xl p-4 md:p-6 shadow-lg">
                    <div className="flex items-center justify-between mb-3 md:mb-4">
                      <p className="text-xs md:text-sm font-semibold opacity-90">My Pledges</p>
                      <Target size={18} className="opacity-70 md:w-5 md:h-5" />
                    </div>
                    <p className="text-2xl md:text-3xl font-black mb-2">{myPledges.length}</p>
                    <p className="text-xs md:text-sm opacity-90">
                      {myPledges.filter(p => p.status !== 'completed').length} active
                    </p>
                  </div>
                )}

               {canViewAllPledges() && (
                <div className="bg-gradient-to-br from-purple-500 to-pink-600 text-white rounded-xl p-4 md:p-6 shadow-lg">
                  <div className="flex items-center justify-between mb-3 md:mb-4">
                    <p className="text-xs md:text-sm font-semibold opacity-90">Total Pledges</p>
                    <Users size={18} className="opacity-70 md:w-5 md:h-5" />
                  </div>
                  <p className="text-2xl md:text-3xl font-black mb-2">{allPledges.length}</p>
                  <p className="text-xs md:text-sm opacity-90">
                    {allPledges.filter(p => p.status === 'completed').length} completed
                  </p>
                </div>
              )}

              {canViewAllPayments() && (
                <div className="bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-xl p-4 md:p-6 shadow-lg">
                  <div className="flex items-center justify-between mb-3 md:mb-4">
                    <p className="text-xs md:text-sm font-semibold opacity-90">Amount Collected</p>
                    <DollarSign size={18} className="opacity-70 md:w-5 md:h-5" />
                  </div>
                  <p className="text-2xl md:text-3xl font-black mb-2">
                    KES {(payments.filter(p => p.status === 'success').reduce((sum, p) => sum + (p.amount || 0), 0) / 1000000).toFixed(1)}M
                  </p>
                  <p className="text-xs md:text-sm opacity-90">
                    {payments.filter(p => p.status === 'success').length} successful
                  </p>
                </div>
              )}

              {canViewCampaigns() && (
                <div className="bg-gradient-to-br from-orange-500 to-red-600 text-white rounded-xl p-4 md:p-6 shadow-lg">
                  <div className="flex items-center justify-between mb-3 md:mb-4">
                    <p className="text-xs md:text-sm font-semibold opacity-90">Active Campaigns</p>
                    <TrendingUp size={18} className="opacity-70 md:w-5 md:h-5" />
                  </div>
                  <p className="text-2xl md:text-3xl font-black mb-2">{campaigns.length}</p>
                  <p className="text-xs md:text-sm opacity-90">
                    {campaigns.filter(c => c.status === 'active').length} running
                  </p>
                </div>
              )}
            </div>

            {/* Welcome Message */}
              <div className="bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4 md:p-8">
                <h3 className="text-base md:text-lg font-bold text-blue-900 dark:text-blue-100 mb-2">
                  üëã Welcome back, {user?.name}!
                </h3>
                <p className="text-sm md:text-base text-blue-800 dark:text-blue-200">
                  This dashboard shows your giving activity and campaign progress. Use the {' '}
                  <span className="hidden md:inline">tabs above</span>
                  <span className="md:hidden">cards above</span>
                  {' '}to manage pledges, view payments, and access detailed reports.
                </p>
              </div>

              {/* Recent Campaigns - Mobile Optimized */}
              {canViewCampaigns() && campaigns.length > 0 && (
                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-4 md:p-6 border border-slate-200 dark:border-slate-700">
                  <h3 className="text-base md:text-lg font-bold text-slate-900 dark:text-white mb-4 md:mb-6">
                    Active Campaigns
                  </h3>
                  
                  {/* Mobile: Stacked Cards */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    {campaigns.slice(0, 4).map(campaign => {
                      const progress = campaign.currentAmount > 0 
                        ? Math.round((campaign.currentAmount / campaign.goalAmount) * 100) 
                        : 0;
                      
                      return (
                        <div
                          key={campaign._id}
                          className="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3 md:p-4 border border-slate-200 dark:border-slate-600"
                        >
                          <h4 className="font-bold text-sm md:text-base text-slate-900 dark:text-white mb-2 line-clamp-2">
                            {campaign.title}
                          </h4>
                          <div className="space-y-2 text-xs md:text-sm mb-3 md:mb-4">
                            <div className="flex justify-between">
                              <span className="text-slate-600 dark:text-slate-400">Goal:</span>
                              <span className="font-semibold">{formatCurrency(campaign.goalAmount)}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-slate-600 dark:text-slate-400">Raised:</span>
                              <span className="font-semibold text-green-600">{formatCurrency(campaign.currentAmount)}</span>
                            </div>
                          </div>
                          <div className="w-full h-2 bg-slate-200 dark:bg-slate-600 rounded-full overflow-hidden mb-2">
                            <div
                              className="h-full bg-green-500 transition-all duration-300"
                              style={{ width: `${Math.min(progress, 100)}%` }}
                            ></div>
                          </div>
                          <p className="text-xs text-slate-500 dark:text-slate-400 text-right">
                            {progress}% complete
                          </p>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          )}


          {/* ANALYTICS TAB - Mobile & Desktop Responsive */}
          {activeTab === 'analytics' && (
            <div className="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden md:p-6">
              {isLoadingAnalytics ? (
                <div className="flex justify-center items-center py-20">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#8B1A1A]"></div>
                </div>
              ) : analyticsData ? (
                <DonationsAnalyticsDashboard data={analyticsData} />
              ) : (
                <div className="bg-yellow-50 dark:bg-yellow-950/30 border border-yellow-200 dark:border-yellow-800 rounded-xl p-8 text-center">
                  <p className="text-yellow-800 dark:text-yellow-200">No analytics data available</p>
                </div>
              )}
            </div>
          )}


          {/* ‚úÖ MY PLEDGES TAB - ENHANCED USER VIEW */}
          {activeTab === 'my-pledges' && (
            <EnhancedUserPledgeView
              pledges={myPledges}
              onPayPledge={(pledge) => setSelectedPledgeForPayment(pledge)}
            />
          )}

          {/* ‚úÖ ALL PLEDGES TAB - ENHANCED ADMIN TABLE */}
          {activeTab === 'all-pledges' && canViewAllPledges() && (
            <EnhancedAdminPledgeTable
              pledges={allPledges}
              onRecordPayment={(pledge) => setSelectedPledgeForManual(pledge)}
              onViewHistory={(pledge) => setSelectedPledgeForHistory(pledge)}
              onEditPledge={handleEditPledge}        
              onCancelPledge={handleCancelPledge}
            />
          )}

          {/* PAYMENTS TAB (ADMIN) */}
        {activeTab === 'payments' && canViewAllPayments() && (
          <div className="bg-white dark:bg-slate-800 rounded-xl shadow-lg overflow-hidden border border-slate-200 dark:border-slate-700">
            {payments.length === 0 ? (
              <div className="text-center py-12">
                <DollarSign size={48} className="mx-auto mb-4 text-slate-300 dark:text-slate-600" />
                <p className="text-lg font-semibold text-slate-900 dark:text-white">
                  No payments yet
                </p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full text-left text-sm">
                  <thead className="bg-slate-100 dark:bg-slate-900">
                    <tr className="border-b border-slate-200 dark:border-slate-700">
                      <th className="px-6 py-4 font-bold text-slate-600 dark:text-slate-400">Phone</th>
                      <th className="px-6 py-4 font-bold text-slate-600 dark:text-slate-400">Amount</th>
                      <th className="px-6 py-4 font-bold text-slate-600 dark:text-slate-400">Method</th>
                      <th className="px-6 py-4 font-bold text-slate-600 dark:text-slate-400">Status</th>
                      <th className="px-6 py-4 font-bold text-slate-600 dark:text-slate-400">Date</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-200 dark:divide-slate-700">
                    {payments.map(payment => (
                      <tr key={payment.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                        <td className="px-6 py-4 font-medium text-slate-900 dark:text-white">
                          {payment.mpesa_phone_number || 'Manual'}
                        </td>
                        <td className="px-6 py-4 font-bold text-slate-900 dark:text-white">
                          {formatCurrency(payment.amount)}
                        </td>
                        <td className="px-6 py-4 capitalize text-slate-700 dark:text-slate-300">
                          {payment.payment_method}
                        </td>
                        <td className="px-6 py-4">
                          <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                            payment.status === 'success'
                              ? 'bg-green-100 dark:bg-green-950/30 text-green-800 dark:text-green-200'
                              : 'bg-yellow-100 dark:bg-yellow-950/30 text-yellow-800 dark:text-yellow-200'
                          }`}>
                            {payment.status.charAt(0).toUpperCase() + payment.status.slice(1)}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-slate-600 dark:text-slate-400">
                          {formatDate(payment.created_at)}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}

        {/* CAMPAIGNS TAB (ADMIN) */}
        {activeTab === 'campaigns' && canViewCampaigns() && (
          <div className="space-y-6">
            {canCreateCampaign() && (
              <AdminCampaignManager onCampaignCreated={handleCampaignCreated} />
            )}

            {activeTab === 'campaigns' && canViewCampaigns() && (
                <CampaignsTab onCampaignCreated={handleCampaignCreated} />
              )}
          </div>
        )}
        </div>
      </div>
